Redis BigKey
------------

##### 什么算Big key

*   **字符串类型**：它的big体现在单个value值很大，一般认为超过10KB就是bigkey。
*   **非字符串类型**：哈希、列表、集合、有序集合，它们的big体现在元素个数太多。

##### 危害

1.   Redis单线程的特性，操作bigkey的通常比较耗时，也就意味着阻塞Redis可能性越大，可能会出现超时阻塞
2.   网络拥塞：每次获取传输的数据也大
3.   过期删除：删除操作可能会比较耗时
4.   迁移困难

##### 怎么产生的

bigkey的产生都是由于程序设计不当，或者对于数据规模预料不清楚造成的

1.   社交类：粉丝列表
2.   统计类：统计网站所有用户
3.   缓存：数据库缓存来的大字段

##### 如何发现

redis-cli提供了--bigkeys来查找bigkey

bigkeys对问题的排查非常方便，但是在使用它时候也有几点需要注意:

建议在从节点执行，因为--bigkeys也是通过scan完成的。建议在节点本机执行，这样可以减少网络开销。如果没有从节点，可以使用--i参数，例如(--i 0.1 代表100毫秒执行一次)--bigkeys只能计算每种数据结构的top1，如果有些数据结构非常多的bigkey，也搞不定，毕竟不是自己写的东西嘛

Redis 4.0开始提供**memory usage命令**可以计算每个键值的字节数

##### 如何删除

由于big key过于大，删除可能会导致阻塞，所以建议采用渐进式的方式来完成：**hscan、ltrim、sscan、zscan**

**字符串：**删除不会产生阻塞

hash:使用hscan命令，每次获取部分(例如100个)field-value，在利用hdel删除每个field(为了快速可以使用pipeline)。

list:ltrim这样的命令可以渐进式的删除列表元素，直到把列表删除

set:使用sscan命令，每次获取部分(例如100个)元素，在利用srem删除每个元素。

sorted set:使用zscan命令，每次获取部分(例如100个)元素，在利用zremrangebyrank删除元素。




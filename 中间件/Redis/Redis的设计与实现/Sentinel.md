Redis高可用解决方案：由一个或多个Sentinel实例（instance）组成的Sentinel系统（system）来监视任意多个主服务器，以及这些主服务器属下的所有从服务器，并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，然后由新的主服务器代替已下线的主服务器继续处理命令请求

### 故障后选主策略

**也就是Raft算法实现**

❑首先，Sentinel系统会挑选server1属下的其中一个从服务器，并将这个被选中的从服务器升级为新的主服务器。

❑之后，Sentinel系统会向server1属下的所有从服务器发送新的复制指令，让它们成为新的主服务器的从服务器，当所有从服务器都开始复制新的主服务器时，故障转移操作执行完毕。

❑另外，Sentinel还会继续监视已下线的server1，并在它重新上线时，将它设置为新的主服务器的从服务器。

### Sentinel的启动初始化

启动Sentinel和普通服务器不相同，会将普通Redis服务器使用的代码替换成Sentinel专用代码，PING、SENTINEL、INFO、SUBSCRIBE、UNSUBSCRIBE、PSUBSCRIBE和PUNSUBSCRIBE这七个命令就是客户端可以对Sentinel执行的全部命令了

然后初始化Sentinel状态，sentinelState结构保存了服务器中所有和Sentinel功能有关的状态

初始化主服务器状态，创建连向主服务器的网络连接一共两个连接：命令连接，订阅连接

❑一个是命令连接，这个连接专门用于向主服务器发送命令，并接收命令回复。

❑另一个是订阅连接，这个连接专门用于订阅主服务器的__sentinel__:hello频道。

### 获取主服务器信息

Sentinel默认会以<u>每十秒一次的频率</u>，通过命令连接向被监视的主服务器发送INFO命令，并通过分析INFO命令的回复来获取主服务器的当前信息。、

❑一方面是关于**主服务器本身的信息**，包括run_id域记录的服务器运行ID，以及role域记录的服务器角色；

❑另一方面是关于主服务器属下所有**从服务器的信息**，每个从服务器都由一个"slave"字符串开头的行记录，每行的ip=域记录了从服务器的IP地址，而port=域则记录了从服务器的端口号。根据这些IP地址和端口号，Sentinel无须用户提供从服务器的地址信息，就可以自动发现从服务器。

### 获取从服务器信息

当Sentinel发现主服务器有新的从服务器出现时，Sentinel除了会为这个新的从服务器创建相应的实例结构之外，Sentinel还会创建<u>连接到从服务器的命令连接和订阅连接</u>。然后每10秒进行一次ping命令。得到从服务器的信息

### 向主服务器和从服务器发送信息

在默认情况下，Sentinel会以每两秒一次的频率，通过命令连接向所有被监视的主服务器和从服务器发送命令：这条命令向服务器的__sentinel__:hello频道发送了一条信息

### 接收来自主服务器和从服务器的频道信息

Sentinel既通过命令连接向服务器的__sentinel__:hello频道发送信息，又通过订阅连接从服务器的__sentinel__:hello频道接收信息。



对于监视同一个服务器的多个Sentinel来说，一个Sentinel发送的信息会被其他Sentinel接收到，这些信息会被用于更新其他Sentinel对发送信息Sentinel的认知，也会被用于更新其他Sentinel对被监视服务器的认知。

当Sentinel通过频道信息发现一个新的Sentinel时，它不仅会为新Sentinel在sentinels字典中创建相应的实例结构，还会创建一个连向新Sentinel的命令连接，而新Sentinel也同样会创建连向这个Sentinel的命令连接，最终监视同一主服务器的多个Sentinel将形成相互连接的网络

Sentinel在连接主服务器或者从服务器时，**会同时创建命令连接和订阅连接**，但是在连接其他Sentinel时，**却只会创建命令连接**，而不创建订阅连接。这是因为Sentinel需要通过接收主服务器或者从服务器发来的频道信息来发现未知的新Sentinel，所以才需要建立订阅连接，而相互已知的Sentinel只要使用命令连接来进行通信就足够了。

假设现在有sentinel1、sentinel2、sentinel3三个Sentinel在监视同一个服务器，那么当sentinel1向服务器的__sentinel__:hello频道发送一条信息时，所有订阅了__sentinel__:hello频道的Sentinel（包括sentinel1自己在内）都会收到这条信息

### 检测主观下线状态

在默认情况下，Sentinel会以每秒一次的频率向所有与它创建了命令连接的实例（包括主服务器、从服务器、其他Sentinel在内）发送PING命令，并通过实例返回的PING命令回复来判断实例是否在线。

Sentinel配置文件中的down-after-milliseconds选项指定了Sentinel判断实例进入主观下线所需的时间长度：如果一个实例在down-after-milliseconds毫秒内，连续向Sentinel返回无效回复，那么Sentinel会修改这个实例所对应的实例结构，在结构的flags属性中打开SRI_S_DOWN标识，以此来表示这个实例已经进入主观下线状态。只有多個Sentinel判定下线的情况下，才会认为这个master进入了主观下线。

### 检查客观下线状态

当Sentinel从其他Sentinel那里接收到足够数量的已下线判断之后，Sentinel就会将从服务器判定为客观下线，并对主服务器执行故障转移操作。

### 选举领头Sentinel

Raft选举算法

确定住服务器进入客观下线后，每个sentinel都会要求其他sentinel将自己设为领头，投票原则讲究先到先得，先得到半数以上的则为领头。

### 故障转移

在选举产生出领头Sentinel之后，领头Sentinel将对已下线的主服务器执行故障转移操作，该操作包含以下三个步骤：

1）在已下线主服务器属下的所有从服务器里面，<u>挑选出一个从服务器，并将其转换为主服务器</u>。

2）让已下线主服务器属下的所有从服务器改为复制新的主服务器。

3）将已下线主服务器设置为新的主服务器的从服务器，当这个旧的主服务器重新上线时，它就会成为新的主服务器的从服务器。

故障转移操作第一步要做的就是在已下线主服务器属下的所有从服务器中，挑选出一个状态良好、数据完整的从服务器，然后向这个从服务器<u>发送SLAVEOFno one命令</u>，将这个从服务器转换为主服务器

主服务器是怎么选出来的？1. 删除下线服务器，选出正常在线的服务器2.删除列表中所有最近五秒内没有回复过领头Sentinel的INFO命令的从服务器

3.删除所有与已下线主服务器连接断开超过down-after-milliseconds*10毫秒的从服务器 4.之后再根据服务器优先级，数据的复制偏移量



问题：

>   1.   怎么选择出领头的sentinel
>
>   2.   命令连接和订阅连接分别是什么作用，怎么用的
>
>        >   命令连接用于sentinel之间，或者与服务器之间信息交换，获取主从服务器信息等
>        >
>        >   订阅连接存在sentinel与主从服务器之间，多个sentinel订阅服务器频道，有sentinel给这个服务器发送信息可以被其他的sentinel收到，这个可以用于sentinel之间的节点发现
>
>        

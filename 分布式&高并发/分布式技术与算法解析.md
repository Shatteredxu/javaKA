<img src="assets/分布式知识架构.jpg" alt="分布式知识架构" style="zoom:26%;" />

### 1.分布式系统指标

**性能、资源、可用性和可扩展性**

##### 性能：

吞吐量:

定义：系统在一定时间内可以处理的任务数

常见指标：QPS每秒查询书,TPS每秒事务数，BPS每秒处理数据量，

响应时间：系统响应一个请求或输入需要花费的时间

完成时间：系统真正完成一个请求或处理需要花费的时间，任务并行的目的就是为了缩短完成时间

##### 资源占用

一个系统提供正常能力需要占用的硬件资源，比如 CPU、内存、硬盘等。

##### 可用性

几个9

##### 可扩展性

### 2.分布式互斥

**集中式：**统一向协调者发送申请，由协调者来查看资源是否可用，缺点：信息交互次数太多，同一出现单点故障

**分布式：**向其他的n-1个程序发送申请，“先到先得”和“投票全票通过”的公平访问机制，但通信成本较高，可用性也比集中式算法低，

**令牌环算法：**令牌依次下发到每一个程序，如果当前程序不需要访问，则将令牌传到下一个程序。拿到令牌的程序才有资格访问，这样在一个周期内，每个程序都能访问到临界资源。

令牌环算法的公平性高，在改进单点故障后，稳定性也很高，适用于系统规模较小，并且系统中每个程序使用临界资源的频率高且使用时间比较短的场景，但是对于使用时间长的资源，容易出现饥饿。

### 3.分布式选举

目前常见的选主方法有基于序号选举的算法（ 比如，Bully 算法）、多数派算法（比如，Raft 算法、ZAB 算法）等

##### Bully 算法

Bully 算法在选举过程中，需要用到以下 3 种消息：

*   Election 消息，用于发起选举；
*   Alive 消息，对 Election 消息的应答；
*   Victory 消息，竞选成功的主节点向其他节点发送的宣誓主权的消息。

Bully 算法选举的原则是“长者为大”，意味着它的**假设条件是，集群中每个节点均知道其他节点的 ID。**在此前提下，其具体的选举过程是：

1.  集群中每个节点<u>判断自己的 ID 是否为当前活着的节点中 ID 最大的</u>，如果是，则直接向其他节点发送 Victory 消息，宣誓自己的主权；
2.  如果自己不是当前活着的节点中 ID 最大的，则向比自己 ID 大的所有节点发送 Election 消息，并等待其他节点的回复；
3.  若在给定的时间范围内，本节点没有收到其他节点回复的 Alive 消息，则认为自己成为主节点，并向其他节点发送 Victory 消息，宣誓自己成为主节点；若接收到来自比自己 ID 大的节点的 Alive 消息，则<u>等待其他节点发送 Victory 消息</u>；
4.  若本节点收到比自己 ID 小的节点发送的 Election 消息，则回复一个 Alive 消息，告知其他节点，我比你大，重新选举。

**Bully 算法优点：**选择特别霸道和简单，谁活着且谁的 ID 最大谁就是主节点，选举速度快、算法复杂度低、简单易实现。

**缺点在于**，需要每个节点有全局的节点信息，因此额外信息存储较多；其次，任意一个比当前主节点 ID 大的新节点或节点故障后恢复加入集群的时候，都可能会触发重新选举，成为新的主节点，如果该节点频繁退出、加入集群，就会导致频繁切主。

<u>MongoDB 的副本集故障转移</u>功能就使用了bully算法

##### Raft 算法 民主投票

[Raft](./分布式&高并发\分布式\分布式系统理论.md)

##### 具有优先级的民主投票：ZAB 算法

ZAB选举算法是为 <u>ZooKeeper 实现</u>分布式协调功能而设计的。相较于 Raft 算法的投票机制，ZAB 算法增加了<u>通过节点 ID 和数据 ID 作为参考进行选主</u>，节点 ID 和数据 ID 越大，表示数据越新，优先成为主。相比较于 Raft 算法，ZAB 算法尽可能保证数据的最新性。所以，ZAB 算法可以说是对 Raft 算法的改进。

ZAB 选举算法的核心是“少数服从多数，ID 大的节点优先成为主”，因此选举过程中通过 (vote_id, vote_zxID) 来表明投票给哪个节点，其中 vote_id 表示被投票节点的 ID，vote_zxID 表示被投票节点的服务器 zxID。**ZAB 算法选主的原则是：server_zxID 最大者成为 Leader；若 server_zxID 相同，则 server_id 最大者成为 Leader。**

特点 ：ZAB 算法性能高，采用广播方式发送信息，若节点中有 n 个节点，每个节点同时广播，则集群中信息量为 n*(n-1) 个消息，<u>容易出现广播风暴</u>；且除了投票，还增加了对比节点 ID 和数据 ID，这就意味着还需要知道所有节点的 ID 和数据 ID，所以<u>选举时间相对较长</u>。但该算法选举稳定性比较好，当有新节点加入或节点故障恢复后，会触发选主，但不一定会真正切主，除非新节点或故障后恢复的节点数据 ID 和节点 ID 最大，且获得投票数过半，才会导致切主。

### 4.分布式共识算法


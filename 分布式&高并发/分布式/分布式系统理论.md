分布式系统理论
--------------



![img](assets/分布式知识体系1.png)

<img src="assets/分布式知识体系2.png" alt="img" style="zoom:67%;" />

[TOC]

### 1.分布式系统基本知识

分布式系统特点：**不出现单点故障、服务或者存储无状态等特点**,可扩展

**要求：可扩展性、高性能、高可用、一致性**

评估指标:

### 2.CAP和Base理论

分布式系统中存在 CAP 问题 **一致性**（ Consistency）、**可用性**（ Availability），以及**分区容错性**（ Partition Tolerance）

`CAP理论`:在分布式系统中 C、A、P 这三个特征不能同时满足，只能满足其中两个。

由此引出的多个分布式系统方案`保 CA 弃 P`,`保 CP 弃 A`,`保 AP 弃 C`,他们适用于不同的分布式场景

参考：[CAP理论详细分析](https://blog.csdn.net/weixin_39876592/article/details/112262702)

`BASE理论`:BASE是Basically Available（基本可用）、Soft state（软状态）和Eventually consistent（最终一致性）三个短语的缩写，base理论说即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。

***1. 基本可用***:
 基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性。注意，这绝不等价于系统不可用。比如：

（1）响应时间上的损失。正常情况下，一个在线搜索引擎需要在0.5秒之内返回给用户相应的查询结果，但由于出现故障，查询结果的响应时间增加了1~2秒

（2）系统功能上的损失：正常情况下，在一个电子商务网站上进行购物的时候，消费者几乎能够顺利完成每一笔订单，但是在一些节日大促购物高峰的时候，由于消费者的购物行为激增，为了保护购物系统的稳定性，部分消费者可能会被引导到一个降级页面。

***2、软状态***:
 软状态指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。

***3、最终一致性***:
 最终一致性强调的是所有的数据副本，在经过一段时间的同步之后，最终都能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。

### 3.分布式一致性协议

为了保证分布式系统中多个节点中数据的数值是一致的

##### 两阶段提交**协议**（2PC：Two-Phase Commit）

##### 三阶段提交**协议**（3PC：Three-Phase Commit）

### 4.一致性算法

##### Raft**算法**

https://www.bilibili.com/video/BV13Q4y167Hy?from=search&seid=10233346446578764319&spm_id_from=333.337.0.0

共识算法，三个角色 , follower, candidate, Follower只响应其他服务器的请求。如果Follower超时没有收到Leader的消息，它会成为一个Candidate并且开始一次Leader选举。收到大多数服务器投票的Candidate会成为新的Leader。Leader在宕机之前会一直保持Leader的状态。

1.   Raft算法实现了随机超时时间，每个节点等待领导者节点信条信息的超时时间的随机的，防止所有节点同时发起投票
2.   当A节点超时后，A节点成为候选者，并增加自己的人气编号，并且给自己投一票，然后通过其他选举者通过RPC发送心跳请求，当其他节点收到投票请求后，如果在编号为1的这段任期内，没有进行过投票，就把选票投给节点A, 并增加自己的任期编号，
3.   节点A收到超过N/2的投票，就会从候选者变为领导者，然后固定时间间隔给其他节点发送心跳请求
4.   领导者只要是正常的，没有出现问题，那么领导者就会一直存在，只有当其挂掉，才会有其他节点进行选举

如果一个候选人或者领导者，发现自己任期编号比其他节点小，那么他就会恢复为跟随者，例如主节点宕机后，其他节点任期增加了，当主节点恢复后发现自己任期比其他节点小，则变为跟随者，相反，如果收到比较小的人任期编号，则拒绝这个消息，由于随机的超时时间，保证了同一时间只有一个选举者，所以当主节点宕机后，超时时间最短的就成为了优先的候选人

总结：任期机制，随机心跳，先来先服务的投票远着，多数选举制，任期比较

##### raft脑裂问题



##### paxos**算法**



